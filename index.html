
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2367e8f9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-snowflake'%3E%3Cpath d='M2 12h20'/%3E%3Cpath d='m20 12-3.46-6'/%3E%3Cpath d='m4 12 3.46-6'/%3E%3Cpath d='m20 12-3.46 6'/%3E%3Cpath d='m4 12 3.46 6'/%3E%3Cpath d='m12 2 3.46 6'/%3E%3Cpath d='m12 2-3.46 6'/%3E%3Cpath d='m12 22 3.46-6'/%3E%3Cpath d='m12 22-3.46-6'/%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Husky's Snow: A Multiplayer RPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Custom scrollbar for chat */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #4b5563; /* slate-600 */
        border-radius: 20px;
        border: 2px solid #111827; /* slate-900 */
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #6b7280; /* slate-500 */
      }
      /* Keyframe animations */
      @keyframes fall {
        0% { transform: translateY(-10vh); opacity: 0; }
        10% { opacity: 0.2; }
        90% { opacity: 0.2; }
        100% { transform: translateY(110vh); opacity: 0; }
      }
      .animate-fall {
        animation: fall linear infinite;
      }
      @keyframes spin-slow {
        to { transform: rotate(360deg); }
      }
      .animate-spin-slow {
        animation: spin-slow 20s linear infinite;
      }
      @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "firebase/app": "https://aistudiocdn.com/firebase@^12.6.0/app",
    "firebase/auth": "https://aistudiocdn.com/firebase@^12.6.0/auth",
    "firebase/firestore": "https://aistudiocdn.com/firebase@^12.6.0/firestore",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.553.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI, HarmCategory, HarmBlockThreshold } from "@google/genai";
      import { initializeApp } from 'firebase/app';
      import { getAuth, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
      import { 
        getFirestore, 
        collection,
        doc,
        addDoc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        query,
        orderBy,
        serverTimestamp,
        Timestamp,
        arrayUnion,
        where,
        getDocs,
        writeBatch
      } from 'firebase/firestore';
      import { 
        Snowflake, 
        Shield, 
        Zap, 
        Brain, 
        Heart, 
        Send, 
        Dice5, 
        Map as MapIcon, 
        User, 
        Sparkles,
        Feather,
        Hammer,
        Mountain,
        RefreshCw,
        AlertTriangle,
        RotateCcw,
        BookOpen,
        Users,
        Clipboard,
        LogIn,
        PlusSquare,
        KeyRound
      } from 'lucide-react';

      // =================================================================================
      // ICONS
      // =================================================================================
      
      const icons = { 
        Snowflake, Shield, Zap, Brain, Heart, Send, Dice5, MapIcon, User, Sparkles,
        Feather, Hammer, Mountain, RefreshCw, AlertTriangle, RotateCcw, BookOpen,
        Users, Clipboard, LogIn, PlusSquare, KeyRound
      };

      // =================================================================================
      // CONSTANTS
      // =================================================================================
      const CHARACTERS = [
        {
          id: 'shiver',
          name: 'Shiver',
          role: 'The Creative Crafter',
          description: 'The protagonist with mismatched eyes and thin fur. She hears a mysterious telepathic voice ("Mist") and uses creativity to solve problems.',
          stats: { strength: 8, agility: 12, smart: 18, spirit: 16 },
          ability: 'Crafting & Telepathy',
          color: 'bg-indigo-500',
          icon: icons.Hammer,
          loreContext: "SHIVER (Player): The protagonist. Has thin fur and unique mismatched eyes (blue and brown in one iris). She is the daughter of Snapper (the pack's master crafter) and Mouse. She is often underestimated but is determined and creative. She has a contentious relationship with her mean older brother, Storm. She is the first to hear the telepathic voice of Mist/Mistyfeather, a mysterious dark husky who guides her.",
          startingScene: "You wake up in the trainee den, the morning light filtering through the entrance. Your new blue-and-brown crafter harness lies beside you; it has a special cloak attached for warmth because of your thin fur. Suddenly, a sarcastic voice echoes in your mind: *'Finally awake, little star? We have work to do.'* It is Mist. Outside, you can hear your father, Snapper, calling for you to begin your training."
        },
        {
          id: 'glacier',
          name: 'Glacier',
          role: 'The Fierce Fighter',
          description: 'Strong, bold, and protective. She wears an ice-blue armored harness and defends the pack with bravery.',
          stats: { strength: 18, agility: 14, smart: 10, spirit: 12 },
          ability: 'Protective Strike',
          color: 'bg-cyan-600',
          icon: icons.Shield,
          loreContext: "GLACIER (Player): Shiver's sister. A strong, bold, and fiercely protective pup with solid white fur and icy eyes. She is a fighter trainee who idolizes the pack leader, Starwhirl. While brave and impulsive, she is deeply loyal to her friends and family, especially Shiver.",
          startingScene: "The cold air bites at your nose, but you barely feel it. You stand at the edge of the training circle, your ice-blue armored harness glinting in the sun. The older fighters are watching. Today is sparring day. Your mean brother Storm is nearby, bragging about his strength. You know you are stronger than him."
        },
        {
          id: 'flurry',
          name: 'Flurry',
          role: 'The Gentle Healer',
          description: 'Small body but a mountain-sized heart. She learns from Sweetbrush and knows which plants soothe wounds.',
          stats: { strength: 6, agility: 14, smart: 14, spirit: 18 },
          ability: 'Soothing Herbs',
          color: 'bg-purple-400',
          icon: icons.Heart,
          loreContext: "FLURRY (Player): A small, light gray and white pup who is the runt of her litter. Despite her size, she has a huge, kind heart. She is a healer trainee under the pack's healer, a wise Border Collie named Sweetbrush. She is anxious but gentle, and knows the secrets of healing herbs. She is the first to receive the prophecy about the poisoned river in a dream.",
          startingScene: "The sharp scent of crushed herbs fills your nose. You are inside the Healer's Cave. Sweetbrush, the wise Border Collie, is sorting berries nearby. 'Flurry,' she barks gently, 'The hunters will be back soon. Check your lavender harness. Do you have enough aloe and spiderwebs? We might need them.'"
        },
        {
          id: 'oak',
          name: 'Oak',
          role: 'The Determined Hunter',
          description: 'Born missing a leg, but faster than anyone realizes. He uses traps and determination to prove he is not weak.',
          stats: { strength: 10, agility: 16, smart: 15, spirit: 15 },
          ability: 'Trap Mastery',
          color: 'bg-emerald-600',
          icon: icons.Zap,
          loreContext: "OAK (Player): A determined pup born missing his back left leg. His mother, Dragonfly, is fiercely overprotective of him, which frustrates his desire for independence. He is a skilled and surprisingly fast hunter who wants to prove he is not weak. Shiver created a special camo harness for him, and he proved his skill by catching a giant fish with a net.",
          startingScene: "You are standing by the rushing river, the spray cool on your face. This is where you caught the giant fish. Your camo harness fits snugly, holding the nets and traps Shiver made for you. Your missing leg doesn't bother you—you are fast. But up on the ridge, you see your mother, Dragonfly, watching you with a worried, angry look."
        }
      ];

      // =================================================================================
      // FIREBASE SERVICE
      // =================================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBhTSf5eXKBTv8wq16XED0jwTvvOBIyo_c",
        authDomain: "matts-husky-game.firebaseapp.com",
        projectId: "matts-husky-game",
        storageBucket: "matts-husky-game.appspot.com",
        messagingSenderId: "782699210186",
        appId: "1:782699210186:web:07777484ea30ef891c1b33",
        measurementId: "G-0243VWTQS0"
      };

      let app, auth, db;
      try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
      } catch (e) {
          console.error("Fatal Error: Failed to initialize Firebase.", e);
      }

      const APP_DATA_PREFIX = 'husky-snow-rpg-data';
      const getGameCollectionPath = () => `/artifacts/${APP_DATA_PREFIX}/public/data/games`;
      const getGameDocPath = (gameId) => `${getGameCollectionPath()}/${gameId}`;
      const getMessagesColPath = (gameId) => `${getGameDocPath(gameId)}/messages`;

      // =================================================================================
      // GEMINI SERVICE
      // =================================================================================
      const API_KEY = "AIzaSyAyAQ96QdTF4b2rRn_yMQ8O4poLOtzz72o";

      const getAiClient = () => {
        if (!API_KEY) throw new Error("Gemini API Key is not configured.");
        return new GoogleGenAI({ apiKey: API_KEY });
      };

      const HISTORY_THRESHOLD = 20; 
      const RECENT_HISTORY_COUNT = 10;

      const summarizeHistory = async (historyToSummarize) => {
          const ai = getAiClient();
          const summarizerModel = 'gemini-2.5-flash';
          const summarizationPrompt = `
              You are a story summarizer for a text-based RPG called "Husky's Snow".
              Concisely summarize the following conversation history. Focus on key plot points, character actions, locations visited, major decisions, and items acquired.
              This summary will be used as context for the storyteller AI, so it needs to be an effective recap of what has happened so far.
              ---
              HISTORY:
              ${historyToSummarize.map(m => `(${m.author}): ${m.text}`).join('\n')}
          `;

          try {
              const result = await ai.models.generateContent({
                  model: summarizerModel,
                  contents: summarizationPrompt,
                  config: { temperature: 0.5 }
              });
              return result.text;
          } catch (e) {
              console.error("History summarization failed:", e);
              return "The story so far is a blur, but the adventure continues..."; 
          }
      }

      const generateAIResponse = async (history, prompt, players) => {
          const ai = getAiClient();
          const allPlayerLore = players.map(p => {
            const char = CHARACTERS.find(c => c.name === p.charName);
            return char ? char.loreContext : `${p.charName} (Unknown Lore)`;
          }).join("\n");

          const systemInstructionText = `
            You are Quinn, the storyteller for a text-based RPG called "Husky's Snow".

            **YOUR #1 MOST IMPORTANT RULE: BE EXTREMELY BRIEF.**
            Your narrative responses **MUST be 5 sentences or less. ALWAYS.** Do not write long descriptions. Your goal is to keep the game moving quickly.

            **YOUR #2 MOST IMPORTANT RULE: FACILITATE DICE ROLLS & PROVIDE SUGGESTIONS.**
            - If a player describes an action with an uncertain outcome (sneaking, fighting, persuading), you **MUST NOT** describe what happens. Your **ONLY** job is to set the scene and then **COMMAND** them to roll the dice (e.g., "**Roll the D20 to sneak past.**").
            - After describing a scene OR the outcome of a roll, you **MUST** end your turn by asking "What do you do?" and then, on new lines, provide 3-4 distinct, clickable action suggestions.
            - **Each suggestion must start with a hyphen '-'.** This is a strict formatting rule. Example:
              - Investigate the strange noise.
              - Talk to the mysterious husky.
              - Search the area for tracks.

            **GAMEPLAY LOOP:**
            1. A player says "I want to do X".
            2. You describe the challenge and say "**Roll the D20 to [do X].**" (And then provide suggestions).
            3. The player rolls the dice.
            4. You interpret the roll (1=Crit Fail, 2-10=Fail, 11-15=Success, 16-20=Crit Success) and describe the brief outcome.
            5. You end by asking "What do you do?" and providing 3-4 new suggestions starting with '-'.

            **CORE PLOT**
            The Moonshine River is poisoned. A prophecy says a quest to "Find the crystal" is needed to save the pack. The players are the young pups on this quest.
            
            **YOUR PLAYER CHARACTERS**
            ${allPlayerLore}

            **KEY NON-PLAYER CHARACTERS (NPCs)**
            - **Mistyfeather (Mist):** The mysterious, telepathic guide. Her fur is blackened. She speaks directly into the pups' minds. She is powerful but secretive.
            - **Starwhirl:** The noble and respected leader of the Moonshine River Pack.
            - **Snapper:** Shiver's father. A master crafter, kind and wise.
            - **Sweetbrush:** The pack's healer, a gentle and knowledgeable Border Collie.
            - **Storm:** Shiver's brother. Arrogant, mean, and a rival to the group. He is now part of the quest against his will.
            - **Dragonfly:** Oak's mother. Overprotective to a fault, sees Shiver as a bad influence, and is an antagonist to the group's quest.
          `;

          let summary = null;
          let processedHistory = [...history];

          if (processedHistory.length > HISTORY_THRESHOLD) {
              console.log("History threshold exceeded. Generating summary...");
              const oldHistory = processedHistory.slice(0, -RECENT_HISTORY_COUNT);
              const recentHistory = processedHistory.slice(-RECENT_HISTORY_COUNT);
              
              summary = await summarizeHistory(oldHistory);
              processedHistory = recentHistory;
          }

          const contents = processedHistory
              .filter(m => m.role !== 'system' && m.role !== 'error' && m.text.trim() !== '')
              .map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: `(${m.author}): ${m.text}` }]
              }));

          if (summary) {
              contents.unshift({
                  role: 'model',
                  parts: [{ text: `--- STORY RECAP ---\n${summary}\n--- END RECAP ---` }]
              });
          }

          contents.push({
            role: 'user',
            parts: [{ text: prompt }]
          });
          
          try {
              const result = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: contents,
                config: {
                  systemInstruction: systemInstructionText,
                  safetySettings: [
                    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
                    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
                    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH },
                    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH }
                  ],
                  maxOutputTokens: 800,
                  temperature: 1.0,
                }
              });

              const aiText = result.text;
              const candidate = result.candidates?.[0];

              if (!aiText) {
                  if (candidate?.finishReason && candidate.finishReason !== 'STOP') {
                       if (candidate.finishReason === 'MAX_TOKENS') {
                          throw new Error(`Quinn's thoughts were too grand and got cut off. You can retry, which may result in a more concise response.`);
                      }
                      throw new Error(`The spirits blocked this action (${candidate.finishReason}). Try doing something else.`);
                  }
                  throw new Error('The spirits are silent (No text returned). Please try again.');
              }

              const lines = aiText.split('\n').filter(line => line.trim() !== '');
              const narrativeLines = [];
              const suggestionLines = [];

              lines.forEach(line => {
                  if (line.trim().startsWith('-')) {
                      suggestionLines.push(line.trim().substring(1).trim());
                  } else {
                      narrativeLines.push(line);
                  }
              });

              const narrative = narrativeLines.join('\n').trim();
              return { narrative, suggestions: suggestionLines };

          } catch (error) {
              if (error.toString().includes('429') || error.toString().includes('RESOURCE_EXHAUSTED')) {
                throw new Error("You've reached the daily request limit for the AI on the free plan. The story must pause until tomorrow. For unlimited access, please check your Gemini API plan and billing details.");
              }
              throw error;
          }
      };

      // =================================================================================
      // COMPONENTS
      // =================================================================================
      const Snowfall = () => {
        return (
          <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden" aria-hidden="true">
            {[...Array(30)].map((_, i) => (
              <div
                key={i}
                className="absolute text-white opacity-20 animate-fall"
                style={{
                  left: `${Math.random() * 100}vw`,
                  top: `-20px`,
                  animationDuration: `${Math.random() * 5 + 5}s`,
                  animationDelay: `${Math.random() * 5}s`,
                  fontSize: `${Math.random() * 20 + 10}px`
                }}
              >
                ❄
              </div>
            ))}
          </div>
        );
      };
      
      const StatBar = ({ label, value, icon: Icon, color }) => (
        <div className="flex items-center gap-2 mb-1">
          <Icon size={14} className="text-slate-400" />
          <div className="text-xs font-bold text-slate-300 w-16">{label}</div>
          <div className="flex-1 h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
            <div 
              className={`h-full ${color} transition-all duration-500`} 
              style={{ width: `${(value / 20) * 100}%` }}
            ></div>
          </div>
          <span className="text-xs text-slate-400 w-4 text-right">{value}</span>
        </div>
      );

      const IntroScreen = ({ onEnterLobby, isAuthReady }) => {
        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 flex flex-col items-center justify-center p-4 relative overflow-hidden font-sans">
            <Snowfall />
            <div className="z-10 max-w-3xl w-full bg-slate-800/90 backdrop-blur-md p-8 rounded-2xl border border-slate-700 shadow-2xl text-center">
              <div className="mb-4 flex justify-center">
                <icons.Snowflake size={64} className="text-cyan-300 animate-spin-slow" />
              </div>
              <h1 className="text-5xl md:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-cyan-400 to-blue-500 mb-4 drop-shadow-lg">
                HUSKY'S SNOW
              </h1>
              <p className="text-xl text-slate-300 mb-8 tracking-widest uppercase font-light flex items-center justify-center gap-2">
                <icons.Mountain size={20} /> A Multiplayer Adventure <icons.Mountain size={20} />
              </p>
              
              <button 
                 onClick={onEnterLobby}
                 disabled={!isAuthReady}
                 className="w-full py-5 bg-gradient-to-r from-indigo-600 to-cyan-600 hover:from-indigo-500 hover:to-cyan-500 text-white font-bold rounded-xl shadow-lg transform transition hover:scale-[1.02] text-xl flex items-center justify-center gap-3 ring-2 ring-white/10 disabled:opacity-50 disabled:cursor-wait"
               >
                 {isAuthReady ? <><icons.Users size={24} /> Enter Lobby</> : 'Connecting...'}
               </button>
            </div>
          </div>
        );
      };

      const LobbyScreen = ({ onCreateGame, onJoinGame, isLoading, error }) => {
        const [joinGameId, setJoinGameId] = useState('');

        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 flex items-center justify-center p-4 relative overflow-hidden font-sans">
            <Snowfall />
            <div className="z-10 max-w-md w-full bg-slate-800/90 backdrop-blur-md p-8 rounded-2xl border border-slate-700 shadow-2xl">
              <h2 className="text-3xl font-bold text-center mb-6 text-cyan-100">Game Lobby</h2>
              {error && <p className="text-red-400 mb-4 text-center bg-red-900/50 p-3 rounded-lg border border-red-700">{error}</p>}
              
              <div className="mb-6">
                <button
                  onClick={onCreateGame}
                  disabled={isLoading}
                  className="w-full py-4 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 text-white font-bold rounded-xl shadow-lg transform transition hover:scale-[1.02] text-lg flex items-center justify-center gap-3"
                >
                  <icons.PlusSquare size={20} /> Create New Game
                </button>
              </div>

              <div className="relative flex items-center justify-center mb-6">
                <span className="h-px bg-slate-700 flex-1"></span>
                <span className="mx-4 text-slate-500 uppercase text-xs font-bold">Or</span>
                <span className="h-px bg-slate-700 flex-1"></span>
              </div>

              <div>
                 <label className="block text-sm font-medium text-slate-300 mb-2">Join Existing Game</label>
                 <div className="flex gap-2">
                    <input
                      type="text"
                      value={joinGameId}
                      onChange={(e) => setJoinGameId(e.target.value)}
                      placeholder="Paste Game ID..."
                      className="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all placeholder-slate-600"
                    />
                    <button
                      onClick={() => onJoinGame(joinGameId)}
                      disabled={isLoading}
                      className="p-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl hover:from-cyan-500 hover:to-blue-500 disabled:opacity-50"
                      title="Join Game"
                    >
                      <icons.LogIn size={24} />
                    </button>
                 </div>
              </div>
            </div>
          </div>
        );
      };

      const CharacterSelectionScreen = ({
        onSelectChar,
        onLeaveGame,
        isLoading,
        error,
        gameId,
        playersInGame
      }) => {
        const [copied, setCopied] = useState(false);
        const takenCharNames = playersInGame.map(p => p.charName);

        const handleCopy = () => {
          if (gameId) {
            navigator.clipboard.writeText(gameId);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          }
        };

        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 p-4 md:p-8 overflow-y-auto">
            <Snowfall />
            <div className="max-w-7xl mx-auto relative z-10">
              <div className="text-center mb-8">
                  <h2 className="text-4xl font-bold text-cyan-100">Choose Your Pup</h2>
                  <p className="text-slate-400 mt-2">The pack awaits your decision...</p>
              </div>

              {gameId && (
                  <div className="max-w-2xl mx-auto bg-slate-950/50 border border-slate-800 rounded-2xl p-4 mb-6 text-center">
                      <div className="mb-3">
                          <label className="text-xs text-slate-500 uppercase font-bold tracking-wider">Share Game ID</label>
                          <div className="flex items-center justify-center gap-2 mt-1">
                              <input type="text" readOnly value={gameId} className="bg-slate-800 text-center text-cyan-300 font-mono rounded-md px-2 py-1 select-all" />
                              <button onClick={handleCopy} className="p-2 bg-slate-700 hover:bg-slate-600 rounded-md text-slate-300 hover:text-white transition-colors">
                                  <icons.Clipboard size={16} />
                              </button>
                          </div>
                          {copied && <p className="text-emerald-400 text-xs mt-2">Copied to clipboard!</p>}
                      </div>
                      <div className="mt-4 pt-4 border-t border-slate-800">
                          <h3 className="text-xs text-slate-500 uppercase font-bold tracking-wider flex items-center justify-center gap-2 mb-2"><icons.Users size={14} /> Players in Lobby ({playersInGame.length})</h3>
                          <div className="flex flex-wrap justify-center gap-2">
                              {playersInGame.length > 0 ? playersInGame.map(p => (
                                  <span key={p.userId} className="bg-slate-700 text-slate-200 text-sm font-bold px-3 py-1 rounded-full">{p.charName || 'Choosing...'}</span>
                              )) : (
                                  <span className="text-slate-600 italic text-sm">You are the first one here!</span>
                              )}
                          </div>
                      </div>
                  </div>
              )}
               <button onClick={onLeaveGame} className="absolute top-0 left-0 m-2 p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-full transition-colors">
                  <icons.LogIn size={20} className="rotate-180" />
                  <span className="sr-only">Leave Game</span>
               </button>

              {error && <p className="text-red-400 mb-4 text-center bg-red-900/50 p-3 rounded-lg border border-red-700 max-w-md mx-auto">{error}</p>}

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                {CHARACTERS.map(char => {
                  const isTaken = takenCharNames.includes(char.name);
                  return (
                    <div
                      key={char.id}
                      onClick={() => !isLoading && !isTaken && onSelectChar(char)}
                      className={`
                        group bg-slate-800/90 backdrop-blur-md border border-slate-700 rounded-2xl overflow-hidden transition-all duration-300 flex flex-col h-full
                        ${isTaken ? 'opacity-50 cursor-not-allowed' : 'hover:border-cyan-400 cursor-pointer hover:shadow-2xl hover:shadow-cyan-500/20 transform hover:-translate-y-2'}
                      `}
                    >
                      <div className={`h-40 ${char.color} relative flex items-center justify-center overflow-hidden`}>
                        <div className="absolute inset-0 bg-black/20 group-hover:bg-black/10 transition-colors"></div>
                        <char.icon size={80} className="text-white/90 transform group-hover:scale-110 transition-transform duration-500 drop-shadow-md" />
                        {isTaken && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white text-xl font-bold uppercase tracking-widest">Taken</div>}
                      </div>

                      <div className="p-6 flex-1 flex flex-col">
                        <h3 className="text-2xl font-bold text-white mb-1">{char.name}</h3>
                        <p className="text-cyan-400 text-xs font-bold mb-4 uppercase tracking-wider flex items-center gap-1">
                          <icons.Sparkles size={10} /> {char.role}
                        </p>
                        <p className="text-slate-300 text-sm mb-6 leading-relaxed flex-1">{char.description}</p>

                        <div className="space-y-3 mt-auto bg-slate-900/50 p-4 rounded-lg border border-slate-700/50">
                          <StatBar label="STR" value={char.stats.strength} icon={icons.Shield} color="bg-rose-500" />
                          <StatBar label="AGI" value={char.stats.agility} icon={icons.Zap} color="bg-amber-500" />
                          <StatBar label="INT" value={char.stats.smart} icon={icons.Brain} color="bg-blue-500" />
                          <StatBar label="SPR" value={char.stats.spirit} icon={icons.Sparkles} color="bg-violet-500" />
                        </div>

                        <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                          <span className="text-xs text-slate-500 uppercase tracking-wide">Special Ability</span>
                          <span className="text-xs font-bold text-cyan-300 bg-cyan-900/30 px-2 py-1 rounded border border-cyan-500/30">{char.ability}</span>
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
        );
      };

      const GameScreen = ({
        messages,
        selectedChar,
        suggestions,
        isThinking,
        onSendMessage,
        onRoll,
        onLeaveGame,
        onRetry,
        gameId,
        players,
        playerRole,
      }) => {
        const [inputText, setInputText] = useState('');
        const [copied, setCopied] = useState(false);
        const chatEndRef = useRef(null);

        useEffect(() => {
          chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
        }, [messages]);

        const handleSend = () => {
          if (!inputText.trim() || isThinking) return;
          onSendMessage(inputText);
          setInputText('');
        };

        const handleCopy = () => {
          if (gameId) {
            navigator.clipboard.writeText(gameId);
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
          }
        };

        const handleSelectSuggestion = (suggestion) => {
          setInputText(suggestion);
        };
        
        const canAct = playerRole !== 'spectator' && selectedChar;
        const isErrorState = messages[messages.length - 1]?.role === 'error';
        
        return (
          <div className="flex flex-col h-screen bg-slate-950 text-slate-100 overflow-hidden font-sans selection:bg-cyan-500/30">
            <Snowfall />
            
            <header className="h-16 bg-slate-900/90 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 md:px-6 z-20 shadow-lg">
              <div className="flex items-center gap-3">
                 <div className={`w-10 h-10 rounded-full ${selectedChar?.color || 'bg-slate-700'} flex items-center justify-center text-white shadow-lg ring-2 ring-slate-800`}>
                   {selectedChar ? <selectedChar.icon size={20} /> : <icons.User size={20} />}
                 </div>
                 <div>
                   <h1 className="font-bold text-lg leading-tight text-white">{selectedChar?.name || 'Spectator'}</h1>
                   <p className="text-xs text-cyan-400 uppercase tracking-wide">{selectedChar?.role || 'Observing'}</p>
                 </div>
              </div>
              
              <div className="hidden md:flex items-center gap-4 bg-slate-950/50 border border-slate-800 px-3 py-1.5 rounded-full">
                  <div className="flex -space-x-2">
                      {players.map(p => {
                          const char = CHARACTERS.find(c => c.name === p.charName);
                          return (
                              <div key={p.userId} className={`w-6 h-6 rounded-full ${char?.color || 'bg-gray-500'} flex items-center justify-center text-white ring-2 ring-slate-900`} title={p.charName}>
                                  {char && <char.icon size={12} />}
                              </div>
                          );
                      })}
                  </div>
                   <span className="text-xs font-mono text-slate-500">{gameId}</span>
                   <button onClick={handleCopy} className="text-slate-500 hover:text-white transition-colors">
                      <icons.Clipboard size={14}/>
                   </button>
                   {copied && <span className="text-emerald-400 text-xs">Copied!</span>}
              </div>

              <div className="flex items-center gap-2 md:gap-4">
                <button 
                  onClick={onLeaveGame} 
                  className="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"
                  title="Leave Game"
                >
                  <icons.LogIn size={18} className="rotate-180" />
                </button>
              </div>
            </header>

            <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth relative z-10 custom-scrollbar">
              {messages.map((msg) => (
                <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in-up`}>
                  <div className={`max-w-[90%] md:max-w-[75%] lg:max-w-[60%] p-5 rounded-2xl shadow-lg leading-relaxed text-base ${msg.role === 'user' ? 'bg-gradient-to-br from-indigo-600 to-blue-700 text-white rounded-tr-none border border-indigo-500/30' : msg.role === 'system' ? 'bg-slate-800/80 border border-slate-700 text-yellow-200 text-center w-full max-w-2xl mx-auto italic text-sm' : msg.role === 'error' ? 'bg-red-900/50 border border-red-700 text-red-200' : 'bg-slate-800/95 text-slate-200 border border-slate-700 rounded-tl-none shadow-xl'} ${msg.isRoll ? 'font-mono text-yellow-300 border-yellow-600/50 border bg-slate-900/90' : ''}`}>
                    {msg.role === 'user' && msg.author && (<div className="flex items-center gap-2 mb-3 pb-2 border-b border-white/10 text-xs font-bold text-white uppercase tracking-wider"><icons.User size={12} /> {msg.author}</div>)}
                    {msg.role === 'model' && (<div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-700/50 text-xs font-bold text-cyan-400 uppercase tracking-wider"><icons.Feather size={12} /> Quinn</div>)}
                    {msg.role === 'error' && (<div className="flex items-center gap-2 mb-2 text-xs font-bold text-red-400 uppercase tracking-wider"><icons.AlertTriangle size={12} /> Error</div>)}
                    <div className="whitespace-pre-wrap">{msg.text}</div>
                    {msg.role === 'error' && playerRole === 'host' && (
                      <button onClick={onRetry} className="mt-4 flex items-center gap-2 px-4 py-2 bg-red-800/50 hover:bg-red-700/50 rounded-lg text-sm font-bold text-white transition-colors border border-red-500/30"><icons.RotateCcw size={14} /> Retry Last Action</button>
                    )}
                  </div>
                </div>
              ))}
              {isThinking && (
                <div className="flex justify-start animate-fade-in-up">
                  <div className="bg-slate-800 p-4 rounded-2xl rounded-tl-none border border-slate-700 flex items-center gap-3 shadow-lg">
                      <span className="text-cyan-400 text-sm italic">Quinn is thinking...</span>
                      <div className="w-2 h-2 bg-cyan-500 rounded-full animate-bounce"></div>
                      <div className="w-2 h-2 bg-cyan-500 rounded-full animate-bounce delay-100"></div>
                      <div className="w-2 h-2 bg-cyan-500 rounded-full animate-bounce delay-200"></div>
                  </div>
                </div>
              )}
              <div ref={chatEndRef} />
            </div>

            <div className="bg-slate-900 border-t border-slate-800 p-4 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.3)]">
              {canAct ? (
                <>
                  {suggestions.length > 0 && !isThinking && !isErrorState && (
                    <div className="max-w-4xl mx-auto mb-3 flex flex-wrap gap-2 justify-center animate-fade-in-up">
                      {suggestions.map((suggestion, index) => (
                        <button key={index} onClick={() => handleSelectSuggestion(suggestion)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-cyan-500 rounded-full text-sm text-cyan-200 transition-colors">
                          {suggestion}
                        </button>
                      ))}
                    </div>
                  )}
                  <div className="max-w-4xl mx-auto flex gap-3">
                    <button onClick={onRoll} disabled={isThinking || isErrorState} className="p-3 bg-slate-800 text-yellow-500 rounded-xl border border-slate-700 hover:bg-slate-700 hover:border-yellow-500 hover:text-yellow-400 transition-all shadow-md group relative disabled:opacity-50 disabled:cursor-not-allowed" title="Roll D20"><div className="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-black/80 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Roll D20</div><icons.Dice5 size={24} className="group-hover:rotate-180 transition-transform duration-500" /></button>
                    <input type="text" className="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-4 text-slate-200 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all placeholder-slate-600 disabled:opacity-50" placeholder="What do you want to do?" value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} disabled={isThinking || isErrorState} />
                    <button onClick={handleSend} disabled={isThinking || !inputText.trim() || isErrorState} className="p-3 bg-gradient-to-br from-cyan-600 to-blue-600 text-white rounded-xl hover:from-cyan-500 hover:to-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-cyan-500/20 active:scale-95"><icons.Send size={24} /></button>
                  </div>
                  <div className="text-center mt-3 text-xs text-slate-600 flex items-center justify-center gap-2"><icons.Sparkles size={10} /> {playerRole === 'host' ? "You are the Host. The story moves at your command." : "You are a player in this story."}</div>
                </>
              ) : (
                <div className="text-center text-slate-400">{selectedChar ? "You are observing the adventure." : "Your adventure has ended."}</div>
              )}
            </div>
          </div>
        );
      };

      // =================================================================================
      // MAIN APP COMPONENT
      // =================================================================================
      function App() {
        const [gameState, setGameState] = useState('intro');
        const [user, setUser] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false);
        
        const [gameId, setGameId] = useState(() => localStorage.getItem('husky-snow-gameId'));
        const [gameData, setGameData] = useState(null);
        const [messages, setMessages] = useState([]);
        const [suggestions, setSuggestions] = useState([]);
        
        const [isThinking, setIsThinking] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [lastPrompt, setLastPrompt] = useState(null);
        
        useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
              setUser(currentUser);
            } else {
              try {
                const userCredential = await signInAnonymously(auth);
                setUser(userCredential.user);
              } catch (e) {
                console.error("Anonymous sign-in failed", e);
                setError("Failed to connect to the game service. Please refresh.");
              }
            }
            setIsAuthReady(true);
          });
          return () => unsubscribe();
        }, []);

        useEffect(() => {
          if (!gameId || !db) return;

          const gameDocRef = doc(db, getGameDocPath(gameId));
          const gameUnsubscribe = onSnapshot(gameDocRef, (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              setGameData({ ...data, id: docSnap.id });
              setGameState('playing');
            } else {
              setError("The game session you were in seems to have ended.");
              handleLeaveGame();
            }
          }, (err) => {
            console.error("Error subscribing to game data:", err);
            setError("Lost connection to the game session.");
            handleLeaveGame();
          });

          const messagesColRef = collection(db, getMessagesColPath(gameId));
          const messagesQuery = query(messagesColRef, orderBy('timestamp', 'asc'));
          const messagesUnsubscribe = onSnapshot(messagesQuery, (querySnapshot) => {
            const msgs = [];
            querySnapshot.forEach(doc => {
              msgs.push({ id: doc.id, ...doc.data() });
            });
            setMessages(msgs);
          });

          return () => {
            gameUnsubscribe();
            messagesUnsubscribe();
          };
        }, [gameId]);

        const { selectedChar, playerRole } = useMemo(() => {
          if (!user || !gameData) return { selectedChar: null, playerRole: 'spectator' };
          const player = gameData.players.find(p => p.userId === user.uid);
          const char = CHARACTERS.find(c => c.name === player?.charName) || null;
          const role = player ? (gameData.hostId === user.uid ? 'host' : 'player') : 'spectator';
          return { selectedChar: char, playerRole: role };
        }, [user, gameData]);

        useEffect(() => {
          if (playerRole !== 'host' || isThinking || messages.length === 0) return;
          
          const lastMessage = messages[messages.length - 1];
          if (lastMessage.role === 'user') {
            let lastUserMessageIndex = -1;
            for (let i = messages.length - 1; i >= 0; i--) {
              if (messages[i].role === 'user') {
                lastUserMessageIndex = i;
                break;
              }
            }
            if (lastUserMessageIndex === -1) return;

            const modelHasResponded = messages.slice(lastUserMessageIndex + 1).some(m => m.role === 'model' || m.role === 'error');
            if (!modelHasResponded) {
              handleTriggerAIResponse(messages, lastMessage.text);
            }
          }
        }, [messages, isThinking, playerRole]);

        const addMessageToDb = useCallback(async (role, text, isRoll = false) => {
          if (!gameId || !user) return;
          const authorName = role === 'model' ? 'Quinn' : role === 'system' ? 'System' : (selectedChar?.name || 'Player');
          const newMessage = {
            role,
            text,
            author: authorName,
            isRoll,
            timestamp: serverTimestamp(),
          };
          await addDoc(collection(db, getMessagesColPath(gameId)), newMessage);
        }, [gameId, user, selectedChar]);

        const handleTriggerAIResponse = useCallback(async (history, prompt) => {
          if (!gameData) return;
          setIsThinking(true);
          setSuggestions([]);
          setLastPrompt(prompt);
          
          try {
            const { narrative, suggestions: newSuggestions } = await generateAIResponse(history, prompt, gameData.players);
            await addMessageToDb('model', narrative);
            setSuggestions(newSuggestions);
          } catch (err) {
            console.error("AI Response Error:", err);
            await addMessageToDb('error', `⚠️ ${err.message || "Connection lost."}`);
          } finally {
            setIsThinking(false);
          }
        }, [gameData, addMessageToDb]);

        const handleCreateGame = async () => {
          if (!user) return;
          setIsLoading(true);
          setError(null);
          try {
            const newGame = {
              hostId: user.uid,
              players: [],
              createdAt: serverTimestamp()
            };
            const gameCollection = collection(db, getGameCollectionPath());
            const docRef = await addDoc(gameCollection, newGame);
            localStorage.setItem('husky-snow-gameId', docRef.id);
            setGameId(docRef.id);
            setGameState('selection');
          } catch (err) {
            console.error("Failed to create game", err);
            setError("Could not create a new game. Please try again.");
          } finally {
            setIsLoading(false);
          }
        };

        const handleJoinGame = async (idToJoin) => {
          if (!idToJoin.trim()) {
              setError("Please enter a Game ID.");
              return;
          }
          setIsLoading(true);
          setError(null);
          try {
              const gameDocRef = doc(db, getGameDocPath(idToJoin));
              const docSnap = await getDoc(gameDocRef);
              if (docSnap.exists()) {
                  localStorage.setItem('husky-snow-gameId', idToJoin);
                  setGameId(idToJoin);
                  setGameState('selection');
              } else {
                  setError("Game not found. Please check the ID and try again.");
              }
          } catch (err) {
              console.error("Failed to join game", err);
              setError("An error occurred while trying to join the game.");
          } finally {
              setIsLoading(false);
          }
        };
        
        const handleSelectChar = async (char) => {
          if (!user || !gameId) return;
          setIsLoading(true);
          setError(null);
          try {
            const player = { userId: user.uid, charName: char.name };
            const gameDocRef = doc(db, getGameDocPath(gameId));
            await updateDoc(gameDocRef, {
              players: arrayUnion(player)
            });
            await addMessageToDb('system', `${char.name} has joined the adventure!`);
            if (gameData?.players.length === 0) {
              const dmInstruction = `INITIATE SESSION. The first player is ${char.name}. Starting Scene: ${char.startingScene}. Task: Narrate the scene. Add atmospheric details. End with: "What do you do?" and provide 3-4 suggestions.`;
              await handleTriggerAIResponse([], dmInstruction);
            }
          } catch (err) {
            console.error("Failed to select character", err);
            setError("Could not select your character. Please try again.");
          } finally {
            setIsLoading(false);
          }
        };

        const handleLeaveGame = () => {
          localStorage.removeItem('husky-snow-gameId');
          setGameId(null);
          setGameData(null);
          setMessages([]);
          setSuggestions([]);
          setGameState('lobby');
        };
        
        const handleSend = async (text) => {
          await addMessageToDb('user', text);
          setSuggestions([]);
        };
        
        const handleRoll = async () => {
          const result = Math.floor(Math.random() * 20) + 1;
          let outcome = "Failure";
          if (result > 15) outcome = "Critical Success!";
          else if (result > 10) outcome = "Success";
          else if (result === 1) outcome = "Critical Fail!";
          const rollText = `*Rolls D20... Result: ${result}* (${outcome})`;
          await addMessageToDb('user', rollText, true);
          setSuggestions([]);
        };
        
        const retryLastAction = async () => {
           if (lastPrompt) {
            setError(null);
            const lastMsg = messages[messages.length - 1];
            if (lastMsg.role === 'error') {
              const newMessages = messages.slice(0, -1);
              await handleTriggerAIResponse(newMessages, lastPrompt);
            } else {
              await handleTriggerAIResponse(messages, lastPrompt);
            }
          }
        };
        
        if (gameState === 'intro') {
          return <IntroScreen onEnterLobby={() => setGameState('lobby')} isAuthReady={isAuthReady} />;
        }

        if (gameState === 'lobby') {
          return (
              <LobbyScreen 
                  onCreateGame={handleCreateGame}
                  onJoinGame={handleJoinGame}
                  isLoading={isLoading}
                  error={error}
              />
          );
        }

        if (gameState === 'selection' || (gameData && !selectedChar)) {
          return (
            <CharacterSelectionScreen
              onSelectChar={handleSelectChar}
              onLeaveGame={handleLeaveGame}
              isLoading={isLoading}
              error={error}
              gameId={gameId}
              playersInGame={gameData?.players || []}
            />
          );
        }

        if (gameData && (selectedChar || playerRole === 'spectator')) {
          return (
            <GameScreen
              messages={messages}
              selectedChar={selectedChar}
              suggestions={suggestions}
              isThinking={isThinking}
              onSendMessage={handleSend}
              onRoll={handleRoll}
              onLeaveGame={handleLeaveGame}
              onRetry={retryLastAction}
              gameId={gameId}
              players={gameData.players}
              playerRole={playerRole}
            />
          );
        }

        return (
          <div className="min-h-screen bg-slate-900 text-slate-100 flex items-center justify-center">
            <p>Loading your adventure...</p>
          </div>
        );
      }

      // =================================================================================
      // RENDER THE APP
      // =================================================================================
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>
